name: "Update API docs"

on:
  push:
    branches:
      - "main"

concurrency: api-${{ github.ref }}

jobs:
    apidoc:
        name: Update API docs
        runs-on: ubuntu-latest
        steps:
            - name: "Checkout main repo"
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.ESCORIA_DEPLOYMENT_TOKEN }}
                repository: godot-escoria/escoria-demo-game
                ref: "main"
                path: game
            - name: "Setup Godot for doctool"
              uses: chickensoft-games/setup-godot@v2
              with:
                version: 4.5.1
                use-dotnet: false
            - name: "Build API docs"
              run: |
                cd game
                godot --version
                
                # Warm up project caches (generates .godot/, class cache, etc.)
                godot --headless --editor --path . --quit
                
                # Sanity check that the cache now exists
                ls -al .godot || true
                test -f .godot/global_script_class_cache.cfg && head -n 20 .godot/global_script_class_cache.cfg || true

                # Generate the docs
                godot --doctool ./docs --gdscript-docs res://addons/escoria-core/ --headless --quit --quiet
                
                ls -al docs
                cd ../
            - name: "Checkout docs repo"
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.ESCORIA_DEPLOYMENT_TOKEN }}
                repository: godot-escoria/escoria-docs
                ref: "devel"
                fetch-depth: 0
                path: docs
            - name: "Remove previous API docs"
              run: |
                mv docs/api/index.rst .
                find docs/api/ -maxdepth 1 -type f -delete
                mv index.rst docs/api

                mv docs/api/commands/index.rst .
                rm -rf docs/api/commands/*
                mv index.rst docs/api/commands

                mv docs/api/managers/index.rst .
                rm -rf docs/api/managers/*
                mv index.rst docs/api/managers

                mv docs/api/supporting_classes/index.rst .
                rm -rf docs/api/supporting_classes/*
                mv index.rst docs/api/supporting_classes
            - name: "Update ASHES reference"
              run: |
                apt update && apt install -y python3 python3-pip
                pip3 install setuptools m2r2 lxml
                cd docs
                rm -rf docsource
                mkdir -p docsource
                cp -R ../game/docs/. docsource/
                python3 extractashes.py
                git status
            - name: "Commit"
              uses: EndBug/add-and-commit@v9.1.4
              with:
                add: '["api", "scripting/z_ashes_reference.rst"]'
                message: 'docs: automatic update of API docs'
                push: true
                cwd: "docs"
                branch: "devel"

               
